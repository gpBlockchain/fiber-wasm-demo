<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P2P Channel Manager</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .page-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 0;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .page-header h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 2.5rem;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    button {
      margin: 5px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
    }
    
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .card h3 {
      color: #2c3e50;
      margin-bottom: 16px;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    #output {
      background: #1a1a1a;
      color: #00ff00;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Fira Code', 'Consolas', monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
      border: 2px solid #333;
    }
    
    textarea, input[type="text"], select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
    }
    
    textarea:focus, input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }
    
    .form-hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
      font-style: italic;
    }
    .main-container {
      display: flex;
      gap: 24px;
      margin-top: 0;
    }
    
    .content-area {
      flex: 1;
      min-width: 0;
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .node-controls {
      text-align: center;
    }
    
    .node-controls .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 2s infinite;
    }
    
    .status-online {
      background: #4caf50;
    }
    
    .status-offline {
      background: #f44336;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .info-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .info-card h4 {
      color: #2c3e50;
      margin-bottom: 8px;
      font-size: 1.1rem;
    }
    
    .info-card .value {
      font-family: 'Fira Code', monospace;
      font-size: 0.9rem;
      color: #666;
      word-break: break-all;
    }
    .sidebar {
      width: 420px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 24px;
      height: fit-content;
      position: sticky;
      top: 100px;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .sidebar h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 3px solid #667eea;
      padding-bottom: 12px;
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-section {
      margin-bottom: 32px;
      position: relative;
    }
    
    .sidebar-section::before {
      content: '';
      position: absolute;
      top: -12px;
      left: -24px;
      right: -24px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
    }
    
    .sidebar-section:first-child::before {
      display: none;
    }
    
    .node-item, .channel-item {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      font-size: 12px;
      transition: all 0.3s ease;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }
    
    .node-item:hover, .channel-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
    }
    
    .local-channel-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 1px solid #8a9bff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 11px;
      line-height: 1.4;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
      transition: all 0.3s ease;
      color: #ffffff;
    }
    
    .local-channel-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    }
    
    .channel-state {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 9px;
      font-weight: bold;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .state-awaiting {
      background: linear-gradient(45deg, #ffa726, #ff7043);
      color: #fff;
      box-shadow: 0 2px 4px rgba(255, 167, 38, 0.3);
    }
    
    .state-open {
      background: linear-gradient(45deg, #66bb6a, #43a047);
      color: #fff;
      box-shadow: 0 2px 4px rgba(102, 187, 106, 0.3);
    }
    
    .state-closed {
      background: linear-gradient(45deg, #ef5350, #e53935);
      color: #fff;
      box-shadow: 0 2px 4px rgba(239, 83, 80, 0.3);
    }
    
    .state-ready {
      background: linear-gradient(45deg, #42a5f5, #1e88e5);
      color: #fff;
      box-shadow: 0 2px 4px rgba(66, 165, 245, 0.3);
    }
    .load-more-btn {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .load-more-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    
    .load-more-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }
    
    /* 响应式设计 */
    @media (max-width: 1200px) {
      .sidebar {
        width: 350px;
      }
    }
    
    @media (max-width: 992px) {
      .main-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        position: relative;
        top: 0;
        margin-top: 20px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .page-header h1 {
        font-size: 2rem;
      }
      
      .card {
        padding: 16px;
      }
      
      .info-grid {
        grid-template-columns: 1fr;
      }
      
      .node-controls .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        margin: 4px 0;
      }
    }
    
    @media (max-width: 480px) {
      .page-header {
        padding: 15px 0;
      }
      
      .page-header h1 {
        font-size: 1.5rem;
      }
      
      .card {
        padding: 12px;
        margin-bottom: 16px;
      }
      
      .sidebar {
        padding: 16px;
      }
    }
    
    /* 滚动条样式 */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #5a6fd8, #6a4190);
    }
    
    /* 加载动画 */
    .loading {
      position: relative;
      overflow: hidden;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0% { left: -100%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body>
  <div class="page-header">
    <h1>🚀 P2P Channel Manager</h1>
  </div>
  
  <div class="container">
    <div class="main-container">
      <div class="content-area">
        <!-- 节点控制面板 -->
        <div class="control-panel">
          <div class="card">
            <h3>⚙️ 节点配置</h3>
            <div class="form-group">
              <label>配置文件选择</label>
              <select id="config-file-select">
                <option value="config.yml">默认配置 (config.yml)</option>
                <option value="testnet-config.yml">测试网配置 (testnet-config.yml)</option>
                <option value="dev-config.yml">开发配置 (dev-config.yml)</option>
              </select>
            </div>
            <div class="form-group">
              <label>节点私钥 (32字节十六进制)</label>
              <input type="text" id="private-key-input" placeholder="输入32字节私钥的十六进制字符串，留空使用默认私钥" style="font-family: 'Fira Code', monospace;">
              <div class="form-hint">
                格式: 2db2219027d6c2a206856fed962214cfa47ab1b3da322ce051877c6567bac2c8
              </div>
            </div>
            <div class="form-group">
              <label>Peer ID (32字节十六进制)</label>
              <input type="text" id="peer-id-input" placeholder="输入32字节Peer ID的十六进制字符串，留空使用默认值" style="font-family: 'Fira Code', monospace;">
              <div class="form-hint">
                格式: 0201010101010101010101010101010101010101010101010101010101010101
              </div>
            </div>
          </div>
          
          <div class="card node-controls">
            <h3>🎮 节点控制</h3>
            <div class="button-group">
              <button class="btn-primary" id="init-button" onclick="initWorkers()">
                <span class="status-indicator status-offline" id="node-status"></span>
                启动节点
              </button>
              <button class="btn-secondary" id="stop-button" onclick="stopFiber()">
                停止节点
              </button>
            </div>
          </div>
        </div>

        <!-- RPC 配置区域 -->
        <div class="card">
          <h3>📡 RPC 配置导入</h3>
          <div class="form-group">
            <label>选择配置文件</label>
            <input type="file" id="config-file" accept=".json" style="padding: 8px;">
          </div>
          <div class="form-group">
            <label>或粘贴 JSON 配置</label>
            <textarea id="config-text" rows="4" placeholder='{"commands":[{"name":"connect_peer","params":[{"name":"address","type":"text"}]},{"name":"list_peer","params":[]},...],"params":{"peer":{"address":"...","peer_id":"..."},"channel":{"funding_amount":"...","public":true,"channel_id":"...","close_script":{"code_hash":"...","hash_type":"type","args":"..."},"fee_rate":"..."},"payment":{"invoice":"..."}}}'></textarea>
          </div>
          <button class="btn-primary" onclick="loadConfig()">📥 加载配置</button>
        </div>
        
        <!-- RPC 命令执行区域 -->
        <div class="card">
          <h3>🎯 RPC 命令执行</h3>
          <div class="form-group">
            <label>选择 RPC 命令</label>
            <select id="rpc-command" onchange="updateParamsForm()">
              <option value="">请选择一个命令</option>
            </select>
          </div>
          <div id="params-form"></div>
          <button class="btn-primary" onclick="invokeSelectedCommand()" disabled id="invoke-btn">🚀 执行命令</button>
        </div>
        <!-- 节点信息区域 -->
        <div class="card" id="peers-info" style="display: none;">
          <h3>🌐 连接的节点信息</h3>
          <div id="peers-list" class="info-grid">暂无连接的节点</div>
          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e1e8ed; display: flex; justify-content: space-between; align-items: center;">
            <span id="peers-update-time" style="font-size: 12px; color: #666;">最后更新: 未更新</span>
            <button class="btn-primary" onclick="refreshPeers()" style="padding: 6px 12px; font-size: 12px;">🔄 手动刷新</button>
          </div>
        </div>
        
        <!-- 输出区域 -->
        <div class="card">
          <h3>📋 命令输出</h3>
          <div id="output">等待命令执行...</div>
        </div>
       </div>
       
       <!-- 侧边栏 -->
       <div class="sidebar" id="graph-sidebar">
    <div class="sidebar-section">
      <h3>网络节点 (Graph Nodes)</h3>
      <div id="graph-nodes-list">暂无数据</div>
      <button class="load-more-btn" id="load-more-nodes" onclick="loadMoreNodes()" disabled>加载更多节点</button>
    </div>
    
    <div class="sidebar-section">
      <h3>网络通道 (Graph Channels)</h3>
      <div id="graph-channels-list">暂无数据</div>
      <button class="load-more-btn" id="load-more-channels" onclick="loadMoreChannels()" disabled>加载更多通道</button>
    </div>
    
    <div class="sidebar-section">
      <h3 style="color: #fff; margin-bottom: 15px; font-size: 18px; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">🏠 本地通道 (Local Channels)</h3>
      <div id="local-channels-list">暂无数据</div>
      <button class="load-more-btn" id="refresh-local-channels" onclick="refreshLocalChannels()">刷新本地通道</button>
    </div>
    
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(102, 126, 234, 0.2); text-align: center;">
            <span id="graph-update-time" style="font-size: 11px; color: #666; display: block; margin-bottom: 8px;">最后更新: 未更新</span>
            <button class="btn-primary" onclick="refreshGraphData()" style="padding: 6px 12px; font-size: 11px;">🔄 刷新数据</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="jquery.min.js"></script>
<link rel="stylesheet" href="semantic.min.css">
<script src="semantic.min.js"></script>

<script type="module">
  import { Fiber } from "./dist/index.js";
  // 辅助函数：将十六进制字符串转换为Uint8Array
  function hexStringToUint8Array(hexString) {
    // 移除可能的0x前缀和空格
    hexString = hexString.replace(/^0x/, '').replace(/\s/g, '');
    
    // 检查长度是否为64个字符（32字节）
    if (hexString.length !== 64) {
      throw new Error('私钥必须是64个十六进制字符（32字节）');
    }
    
    // 检查是否只包含有效的十六进制字符
    if (!/^[0-9a-fA-F]+$/.test(hexString)) {
      throw new Error('私钥只能包含十六进制字符（0-9, a-f, A-F）');
    }
    
    const result = new Uint8Array(32);
    for (let i = 0; i < 32; i++) {
      result[i] = parseInt(hexString.substr(i * 2, 2), 16);
    }
    return result;
  }

  window.initWorkers = async () => {
    // 表单验证
    if (!validateForm()) {
      return;
    }
    
    const initButton = document.getElementById('init-button');
    const nodeStatus = document.getElementById('node-status');
    
    initButton.classList.add('loading');
    initButton.disabled = true;
    initButton.innerHTML = '<span class="status-indicator status-offline"></span>正在启动...';
    
    try {
      console.log(Fiber);
      // 获取选择的配置文件
      const configFile = document.getElementById('config-file-select').value;
      const config = await (await fetch(configFile)).text()
      const rpcConfig = await (await fetch("rpc.json")).text()
      const fiber = new Fiber();
      
      // 获取私钥输入
      const privateKeyInput = document.getElementById('private-key-input').value.trim();
      let privateKey;
      
      if (privateKeyInput) {
        // 使用用户输入的私钥
        try {
          privateKey = hexStringToUint8Array(privateKeyInput);
          showMessage('使用自定义私钥初始化节点', 'info');
        } catch (error) {
          showMessage('私钥格式错误: ' + error.message, 'error');
          $("#init-button").removeClass("loading");
          return;
        }
      } else {
        // 使用默认私钥
        privateKey = new Uint8Array([0x2d, 0xb2, 0x21, 0x90, 0x27, 0xd6, 0xc2, 0xa2, 0x06, 0x85, 0x6f, 0xed, 0x96, 0x22, 0x14, 0xcf, 0xa4, 0x7a, 0xb1, 0xb3, 0xda, 0x32, 0x2c, 0xe0, 0x51, 0x87, 0x7c, 0x65, 0x67, 0xba, 0xc2, 0xc8]);
        showMessage('使用默认私钥初始化节点', 'info');
      }
      
      // 根据配置文件选择决定是否读取dev.toml
      let devConfig = undefined;
      if (configFile === 'dev-config.yml') {
        try {
          devConfig = await (await fetch('dev.toml')).text();
          showMessage('已加载dev.toml配置', 'info');
        } catch (error) {
          showMessage('加载dev.toml失败，使用默认配置: ' + error.message, 'warning');
        }
      }
      
      // 获取peer_id输入值
      const peerIdInput = document.getElementById('peer-id-input').value.trim();
      let peerIdBytes;
      
      if (peerIdInput) {
        // 验证输入格式并转换为Uint8Array
        if (!/^[0-9a-fA-F]{64}$/.test(peerIdInput)) {
          showMessage('Peer ID格式错误，应为64位十六进制字符串', 'error');
          return;
        }
        peerIdBytes = new Uint8Array(peerIdInput.match(/.{2}/g).map(byte => parseInt(byte, 16)));
      } else {
        // 使用默认peer_id
        peerIdBytes = new Uint8Array([
          2, 1, 1, 1, 1, 1, 1, 1,
          1, 1, 1, 1, 1, 1, 1, 1,
          1, 1, 1, 1, 1, 1, 1, 1,
          1, 1, 1, 1, 1, 1, 1, 1,
        ]);
      }
      
      await fiber.start(
              config,
              peerIdBytes,
              privateKey,
              devConfig, "info"
      )
      
      console.log('Fiber start successfully');
      console.log(await fiber.invokeCommand("list_peers", []))
      window.fiber = fiber;
      const textInput = document.getElementById('config-text');
      textInput.value = rpcConfig;
      loadConfig();
      
      // 更新状态指示器为在线
      initButton.innerHTML = '<span class="status-indicator status-online"></span>停止节点';
      initButton.onclick = stopFiber;
      initButton.disabled = false;
      
      showMessage('Fiber节点初始化成功', 'success');
      
      // 显示peer信息区域并开始定时刷新
      document.getElementById('peers-info').style.display = 'block';
      await refreshPeers();
      startPeersAutoRefresh();
      
      // 显示侧边栏并初始化图数据
      document.getElementById('graph-sidebar').style.display = 'block';
      await initGraphData();
      startGraphAutoRefresh();
      
      // 初始化本地通道数据
      await loadLocalChannels();
      startLocalChannelsAutoRefresh();
    } catch (error) {
      console.error('初始化失败:', error);
      showMessage('节点初始化失败: ' + error.message, 'error');
      
      // 重置按钮状态
      initButton.innerHTML = '<span class="status-indicator status-offline"></span>启动节点';
      initButton.onclick = initWorkers;
      initButton.disabled = false;
    } finally {
      initButton.classList.remove('loading');
    }
  };

  window.stopFiber = async ()=>{
    const initButton = document.getElementById('init-button');
    
    try {
      initButton.innerHTML = '<span class="status-indicator status-offline"></span>正在停止...';
      initButton.disabled = true;
      
      // 停止定时刷新
      if (window.peersRefreshInterval) {
        clearInterval(window.peersRefreshInterval);
        window.peersRefreshInterval = null;
      }
      // 停止图数据刷新
      if (window.graphRefreshInterval) {
        clearInterval(window.graphRefreshInterval);
        window.graphRefreshInterval = null;
      }
      // 停止本地通道刷新
      if (window.localChannelsRefreshInterval) {
        clearInterval(window.localChannelsRefreshInterval);
        window.localChannelsRefreshInterval = null;
      }
      // 隐藏peer信息区域和侧边栏
      document.getElementById('peers-info').style.display = 'none';
      document.getElementById('graph-sidebar').style.display = 'none';
      
      // 清空图数据
      window.graphNodesData = { nodes: [], lastCursor: null, hasMore: true };
      window.graphChannelsData = { channels: [], lastCursor: null, hasMore: true };
      // 清空本地通道数据
      window.localChannelsData = { channels: [] };
      
      if (window.fiber) {
        window.fiber.stop();
        window.fiber = null;
      }
      
      showMessage('节点已成功停止', 'success');
    } catch (error) {
      console.error('停止节点失败:', error);
      showMessage('停止节点失败: ' + error.message, 'error');
    } finally {
      // 重置按钮状态
      initButton.innerHTML = '<span class="status-indicator status-offline"></span>启动节点';
      initButton.onclick = initWorkers;
      initButton.disabled = false;
    }
  }
  
  // 刷新peer列表
  window.refreshPeers = async () => {
    if (!window.fiber) {
      return;
    }
    
    try {
      const result = await window.fiber.invokeCommand("list_peers", []);
      updatePeersDisplay(result.peers || []);
      document.getElementById('peers-update-time').textContent = `最后更新: ${new Date().toLocaleTimeString()}`;
    } catch (error) {
      console.error('获取peer列表失败:', error);
      document.getElementById('peers-list').innerHTML = '<div style="color: red;">获取节点信息失败: ' + error.message + '</div>';
    }
  }
  
  // 更新peer显示
  function updatePeersDisplay(peers) {
    const peersListElement = document.getElementById('peers-list');
    
    if (!peers || peers.length === 0) {
      peersListElement.innerHTML = '<div style="color: #666;">暂无连接的节点</div>';
      return;
    }
    
    let html = '<div style="font-size: 14px;">';
    peers.forEach((peer, index) => {
      html += `
        <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 3px; border-left: 3px solid #007bff;">
          <div><strong>节点 ${index + 1}:</strong></div>
          <div style="font-family: monospace; font-size: 12px; margin: 2px 0;">
            <strong>Peer ID:</strong> ${peer.peer_id || 'N/A'}
          </div>
          <div style="font-family: monospace; font-size: 12px; margin: 2px 0;">
            <strong>公钥:</strong> ${peer.pubkey || 'N/A'}
          </div>
          <div style="font-size: 12px; margin: 2px 0;">
            <strong>地址:</strong> ${peer.addresses && peer.addresses.length > 0 ? peer.addresses.join(', ') : '无地址信息'}
          </div>
        </div>
      `;
    });
    html += '</div>';
    
    peersListElement.innerHTML = html;
  }
  
  // 开始自动刷新
  function startPeersAutoRefresh() {
    // 每5秒刷新一次
    window.peersRefreshInterval = setInterval(refreshPeers, 5000);
  }
  
  // 图数据相关变量
  window.graphNodesData = {
    nodes: [],
    lastCursor: null,
    hasMore: true
  };
  
  window.graphChannelsData = {
    channels: [],
    lastCursor: null,
    hasMore: true
  };
  
  // 初始化图数据
  window.initGraphData = async () => {
    if (!window.fiber) {
      return;
    }
    
    // 重置数据
    window.graphNodesData = { nodes: [], lastCursor: null, hasMore: true };
    window.graphChannelsData = { channels: [], lastCursor: null, hasMore: true };
    
    // 加载初始数据
    await loadGraphNodes();
    await loadGraphChannels();
    
    document.getElementById('graph-update-time').textContent = `最后更新: ${new Date().toLocaleTimeString()}`;
  }
  
  // 加载图节点数据
  async function loadGraphNodes(isLoadMore = false) {
    if (!window.fiber) return;
    
    try {
      const params = [{ "limit": "0x5" }];
      if (isLoadMore && window.graphNodesData.lastCursor) {
        params[0].after = window.graphNodesData.lastCursor;
      }
      
      const result = await window.fiber.invokeCommand("graph_nodes", params);
      
      if (result.nodes && result.nodes.length > 0) {
        if (isLoadMore) {
          window.graphNodesData.nodes.push(...result.nodes);
        } else {
          window.graphNodesData.nodes = result.nodes;
        }
        window.graphNodesData.lastCursor = result.last_cursor;
        window.graphNodesData.hasMore = result.nodes.length === 5; // 如果返回的数量等于limit，可能还有更多
      } else {
        window.graphNodesData.hasMore = false;
      }
      
      updateGraphNodesDisplay();
      document.getElementById('load-more-nodes').disabled = !window.graphNodesData.hasMore;
      
    } catch (error) {
      console.error('加载图节点失败:', error);
      document.getElementById('graph-nodes-list').innerHTML = '<div style="color: red; font-size: 11px;">加载失败: ' + error.message + '</div>';
    }
  }
  
  // 加载图通道数据
  async function loadGraphChannels(isLoadMore = false) {
    if (!window.fiber) return;
    
    try {
      const params = [{ "limit": "0x5" }];
      if (isLoadMore && window.graphChannelsData.lastCursor) {
        params[0].after = window.graphChannelsData.lastCursor;
      }
      
      const result = await window.fiber.invokeCommand("graph_channels", params);
      
      if (result.channels && result.channels.length > 0) {
        if (isLoadMore) {
          window.graphChannelsData.channels.push(...result.channels);
        } else {
          window.graphChannelsData.channels = result.channels;
        }
        window.graphChannelsData.lastCursor = result.last_cursor;
        window.graphChannelsData.hasMore = result.channels.length === 5;
      } else {
        window.graphChannelsData.hasMore = false;
      }
      
      updateGraphChannelsDisplay();
      document.getElementById('load-more-channels').disabled = !window.graphChannelsData.hasMore;
      
    } catch (error) {
      console.error('加载图通道失败:', error);
      document.getElementById('graph-channels-list').innerHTML = '<div style="color: red; font-size: 11px;">加载失败: ' + error.message + '</div>';
    }
  }
  
  // 更新图节点显示
  function updateGraphNodesDisplay() {
    const nodesListElement = document.getElementById('graph-nodes-list');
    
    if (!window.graphNodesData.nodes || window.graphNodesData.nodes.length === 0) {
      nodesListElement.innerHTML = '<div style="color: #666; font-size: 11px;">暂无节点数据</div>';
      return;
    }
    
    let html = '';
    window.graphNodesData.nodes.forEach((node, index) => {
      const nodeId = node.node_id ? node.node_id.substring(0, 16) + '...' : 'N/A';
      const nodeName = node.node_name || '未命名节点';
      const addressCount = node.addresses ? node.addresses.length : 0;
      const udtCount = node.udt_cfg_infos ? node.udt_cfg_infos.length : 0;
      
      html += `
        <div class="node-item">
          <div style="font-weight: bold; margin-bottom: 4px;">${nodeName}</div>
          <div style="font-family: monospace; margin-bottom: 2px;">ID: ${nodeId}</div>
          <div style="margin-bottom: 2px;">地址: ${addressCount} 个</div>
          <div>UDT配置: ${udtCount} 个</div>
        </div>
      `;
    });
    
    nodesListElement.innerHTML = html;
  }
  
  // 更新图通道显示
  function updateGraphChannelsDisplay() {
    const channelsListElement = document.getElementById('graph-channels-list');
    
    if (!window.graphChannelsData.channels || window.graphChannelsData.channels.length === 0) {
      channelsListElement.innerHTML = '<div style="color: #666; font-size: 11px;">暂无通道数据</div>';
      return;
    }
    
    let html = '';
    window.graphChannelsData.channels.forEach((channel, index) => {
      const outpoint = channel.channel_outpoint ? channel.channel_outpoint.substring(0, 16) + '...' : 'N/A';
      const node1 = channel.node1 ? channel.node1.substring(0, 16) + '...' : 'N/A';
      const node2 = channel.node2 ? channel.node2.substring(0, 16) + '...' : 'N/A';
      const capacity = channel.capacity ? parseInt(channel.capacity, 16).toLocaleString() : 'N/A';
      const enabled1 = channel.update_info_of_node1?.enabled ? '启用' : '禁用';
      const enabled2 = channel.update_info_of_node2?.enabled ? '启用' : '禁用';
      
      html += `
        <div class="channel-item">
          <div style="font-weight: bold; margin-bottom: 4px;">通道 ${index + 1}</div>
          <div style="font-family: monospace; margin-bottom: 2px;">ID: ${outpoint}</div>
          <div style="margin-bottom: 2px;">节点1: ${node1} (${enabled1})</div>
          <div style="margin-bottom: 2px;">节点2: ${node2} (${enabled2})</div>
          <div>容量: ${capacity}</div>
        </div>
      `;
    });
    
    channelsListElement.innerHTML = html;
  }
  
  // 加载更多节点
  window.loadMoreNodes = async () => {
    document.getElementById('load-more-nodes').disabled = true;
    await loadGraphNodes(true);
  }
  
  // 加载更多通道
  window.loadMoreChannels = async () => {
    document.getElementById('load-more-channels').disabled = true;
    await loadGraphChannels(true);
  }
  
  // 刷新图数据
  window.refreshGraphData = async () => {
    await initGraphData();
  }
  
  // 开始图数据自动刷新
  function startGraphAutoRefresh() {
    // 每30秒刷新一次图数据
    window.graphRefreshInterval = setInterval(refreshGraphData, 30000);
  }
  
  // 本地通道相关变量
  window.localChannelsData = {
    channels: []
  };
  
  // 获取本地通道信息
  async function loadLocalChannels() {
    if (!window.fiber) return;
    
    try {
      const result = await window.fiber.invokeCommand("list_channels", [{ "include_closed": true }]);
      
      if (result.channels && result.channels.length > 0) {
        window.localChannelsData.channels = result.channels;
      } else {
        window.localChannelsData.channels = [];
      }
      
      updateLocalChannelsDisplay();
      
    } catch (error) {
      console.error('加载本地通道失败:', error);
      document.getElementById('local-channels-list').innerHTML = '<div style="color: red; font-size: 11px;">加载失败: ' + error.message + '</div>';
    }
  }
  
  // 更新本地通道显示
  function updateLocalChannelsDisplay() {
    const channelsListElement = document.getElementById('local-channels-list');
    
    if (!window.localChannelsData.channels || window.localChannelsData.channels.length === 0) {
      channelsListElement.innerHTML = '<div style="color: #666; font-size: 11px;">暂无本地通道</div>';
      return;
    }
    
    let html = '';
    window.localChannelsData.channels.forEach((channel, index) => {
      const channelId = channel.channel_id ? channel.channel_id.substring(0, 16) + '...' : 'N/A';
      const peerId = channel.peer_id ? channel.peer_id.substring(0, 16) + '...' : 'N/A';
      const outpoint = channel.channel_outpoint ? channel.channel_outpoint.substring(0, 16) + '...' : 'N/A';
      
      // 状态处理
      const stateName = channel.state?.state_name || 'UNKNOWN';
      const stateFlags = channel.state?.state_flags || '';
      let stateClass = 'state-awaiting';
      if (stateName.includes('READY')) {
        stateClass = 'state-ready';
      } else if (stateName.includes('OPEN')) {
        stateClass = 'state-open';
      } else if (stateName.includes('CLOSED')) {
        stateClass = 'state-closed';
      }
      
      // 余额处理
      const localBalance = channel.local_balance ? parseInt(channel.local_balance, 16).toLocaleString() : '0';
      const remoteBalance = channel.remote_balance ? parseInt(channel.remote_balance, 16).toLocaleString() : '0';
      const offeredTlcBalance = channel.offered_tlc_balance ? parseInt(channel.offered_tlc_balance, 16).toLocaleString() : '0';
      const receivedTlcBalance = channel.received_tlc_balance ? parseInt(channel.received_tlc_balance, 16).toLocaleString() : '0';
      
      // 时间处理
      const createdAt = channel.created_at ? new Date(parseInt(channel.created_at, 16)).toLocaleString() : 'N/A';
      
      // 费用设置
      const tlcExpiryDelta = channel.tlc_expiry_delta ? parseInt(channel.tlc_expiry_delta, 16).toLocaleString() : 'N/A';
      const feeRate = channel.tlc_fee_proportional_millionths ? parseInt(channel.tlc_fee_proportional_millionths, 16) : 0;
      
      html += `
        <div class="local-channel-item">
          <div style="margin-bottom: 8px; display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
            <span class="channel-state ${stateClass}">${stateName}</span>
            ${channel.is_public ? '<span style="background: linear-gradient(45deg, #29b6f6, #1e88e5); color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 8px; font-weight: 500; box-shadow: 0 1px 3px rgba(41, 182, 246, 0.3);">公开</span>' : '<span style="background: linear-gradient(45deg, #78909c, #546e7a); color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 8px; font-weight: 500; box-shadow: 0 1px 3px rgba(120, 144, 156, 0.3);">私有</span>'}
            ${channel.enabled ? '<span style="background: linear-gradient(45deg, #81c784, #66bb6a); color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 8px; font-weight: 500; box-shadow: 0 1px 3px rgba(129, 199, 132, 0.3);">启用</span>' : '<span style="background: linear-gradient(45deg, #e57373, #ef5350); color: #fff; padding: 2px 6px; border-radius: 8px; font-size: 8px; font-weight: 500; box-shadow: 0 1px 3px rgba(229, 115, 115, 0.3);">禁用</span>'}
          </div>
          <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; margin-bottom: 3px; font-weight: bold; color: #e3f2fd; font-size: 12px;">🆔 ${channelId}</div>
           <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; margin-bottom: 3px; color: #bbdefb;">👤 ${peerId}</div>
           <div style="font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; margin-bottom: 6px; color: #90caf9; font-size: 10px;">📍 ${outpoint}</div>
           <div style="margin-bottom: 3px; color: #c8e6c9; display: flex; justify-content: space-between;"><span>💰 本地余额:</span><span style="font-weight: 600;">${localBalance}</span></div>
           <div style="margin-bottom: 3px; color: #ffcdd2; display: flex; justify-content: space-between;"><span>💳 远程余额:</span><span style="font-weight: 600;">${remoteBalance}</span></div>
           <div style="margin-bottom: 3px; color: #fff3e0; display: flex; justify-content: space-between;"><span>📤 待发送TLC:</span><span style="font-weight: 600;">${offeredTlcBalance}</span></div>
           <div style="margin-bottom: 3px; color: #e1f5fe; display: flex; justify-content: space-between;"><span>📥 待接收TLC:</span><span style="font-weight: 600;">${receivedTlcBalance}</span></div>
           <div style="margin-bottom: 3px; color: #f3e5f5; display: flex; justify-content: space-between;"><span>💸 费率:</span><span style="font-weight: 600;">${feeRate} ppm</span></div>
           <div style="margin-bottom: 4px; color: #fce4ec; display: flex; justify-content: space-between;"><span>⏰ TLC过期:</span><span style="font-weight: 600;">${tlcExpiryDelta}</span></div>
           <div style="font-size: 9px; color: #b39ddb; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 4px;">📅 ${createdAt}</div>
           ${stateFlags ? `<div style="font-size: 9px; color: #b39ddb; margin-top: 2px; font-style: italic;">🏷️ ${stateFlags}</div>` : ''}
        </div>
      `;
    });
    
    channelsListElement.innerHTML = html;
  }
  
  // 刷新本地通道
  window.refreshLocalChannels = async () => {
    await loadLocalChannels();
    document.getElementById('graph-update-time').textContent = `最后更新: ${new Date().toLocaleTimeString()}`;
  }
  
  // 开始本地通道自动刷新
  function startLocalChannelsAutoRefresh() {
    // 每10秒刷新一次本地通道
    window.localChannelsRefreshInterval = setInterval(refreshLocalChannels, 10000);
  }
</script>
<script>
  // Default configuration (empty until loaded)
  let config = {
    commands: [],
    params: {}
  };

  // Initialize workers (placeholder for Web Worker or similar)
  function initializeWorkers() {
    console.log("Initializing workers...");
    displayOutput("Workers initialized (assuming window.fiber is ready).");
  }

  // Utility to display output
  function displayOutput(message) {
    const outputDiv = document.getElementById('output');
    outputDiv.textContent = `\n${new Date().toISOString()}: ${message}`;
    outputDiv.scrollTop = outputDiv.scrollHeight;
  }

  // Show message function for user feedback
  function showMessage(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    displayOutput(`${type.toUpperCase()}: ${message}`);
  }

  function getValueByType(input,type){
    // param.type === 'checkbox' ? input.checked : input.value;
    if (type === 'checkbox'){
      return input.checked;
    } else if (type === 'json') {
      try {
        return JSON.parse(input.value);
      } catch (e) {
        displayOutput(`Error parsing JSON: ${e.message}`);
        return null;
      }
    } else {
      return input.value;
    }
  }

  // Load configuration from file or textarea
  function loadConfig() {
    const fileInput = document.getElementById('config-file');
    const textInput = document.getElementById('config-text');
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          config = JSON.parse(e.target.result);
          displayOutput("Configuration loaded from file.");
          populateCommandDropdown();
          updateParamsForm();
        } catch (error) {
          displayOutput(`Error parsing JSON file: ${error.message}`);
        }
      };
      reader.readAsText(file);
    } else if (textInput.value.trim()) {
      try {
        config = JSON.parse(textInput.value);
        displayOutput("Configuration loaded from textarea.");
        populateCommandDropdown();
        updateParamsForm();
      } catch (error) {
        displayOutput(`Error parsing JSON text: ${error.message}`);
      }
    } else {
      displayOutput("No configuration provided.");
    }
  }

  // Populate RPC command dropdown from config
  function populateCommandDropdown() {
    const select = document.getElementById('rpc-command');
    select.innerHTML = '<option value="">Select a command</option>';
    config.commands.forEach(cmd => {
      const option = document.createElement('option');
      option.value = cmd.name;
      option.textContent = cmd.name;
      select.appendChild(option);
    });
  }

  // Utility to get parameter value from config.params
  function getParamValue(paramName) {
    const parts = paramName.split('.');
    let value = config.params;
    for (const part of parts) {
      value = value[part];
      if (value === undefined) return '';
    }
    return typeof value === 'object' ? JSON.stringify(value) : value;
  }

  // Update parameter form based on selected RPC command
  function updateParamsForm() {
    const commandName = document.getElementById('rpc-command').value;
    const paramsForm = document.getElementById('params-form');
    const invokeBtn = document.getElementById('invoke-btn');
    paramsForm.innerHTML = '';
    invokeBtn.disabled = !commandName;

    if (!commandName) return;

    const command = config.commands.find(cmd => cmd.name === commandName);
    if (!command) return;

    command.params.forEach(param => {
      const div = document.createElement('div');
      const label = document.createElement('label');
      label.textContent = param.name;
      let input;
      if (param.type === 'checkbox') {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = getParamValue(param.name) === true;
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = getParamValue(param.name);
      }
      input.id = `param-${param.name.replace('.', '-')}`;
      div.appendChild(label);
      div.appendChild(input);
      paramsForm.appendChild(div);
    });
  }

  // Invoke selected RPC command with form parameters
  async function invokeSelectedCommand() {
    const commandName = document.getElementById('rpc-command').value;
    const invokeBtn = document.getElementById('invoke-btn');
    
    if (!commandName) {
      showMessage('请选择要执行的命令', 'warning');
      return;
    }

    const command = config.commands.find(cmd => cmd.name === commandName);
    if (!command) {
      displayOutput(`❌ 错误: 在配置中未找到命令 ${commandName}`);
      showMessage(`命令 ${commandName} 未找到`, 'error');
      return;
    }

    // 设置加载状态
    invokeBtn.disabled = true;
    invokeBtn.innerHTML = '⏳ 执行中...';
    displayOutput(`🚀 正在执行命令: ${commandName}...`);

    let params = [];
    if (command.params.length > 0) {
      let paramObj = {};
      command.params.forEach(param => {
        const input = document.getElementById(`param-${param.name.replace('.', '-')}`);
        if (input.value.length === 0 && !input.checked) {
          return; // Skip empty inputs
        }
        if (param.name.includes('.')) {
          const [parent, child] = param.name.split('.');
          if (!paramObj[parent]) paramObj[parent] = {};
          paramObj[parent][child] = getValueByType(input, param.type);
        } else {
          paramObj[param.name] = getValueByType(input, param.type);
        }
      });
      params = [paramObj];
    }

    try {
      const startTime = Date.now();
      const result = await window.fiber.invokeCommand(commandName, params);
      const duration = Date.now() - startTime;
      
      showMessage(`✅ 命令执行成功 (${duration}ms)\n命令: ${commandName}\n参数: ${JSON.stringify(params, null, 2)}\n结果:\n${JSON.stringify(result, null, 2)}`);
    } catch (error) {
      showMessage(`❌ 命令执行失败\n命令: ${commandName}\n参数: ${JSON.stringify(params, null, 2)}\n错误: ${error}`);
    } finally {
      // 重置按钮状态
      invokeBtn.disabled = false;
      invokeBtn.innerHTML = '🚀 执行命令';
    }
  }

  // 添加键盘快捷键支持
  document.addEventListener('keydown', function(event) {
    // Ctrl/Cmd + Enter 执行命令
    if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
      event.preventDefault();
      const invokeBtn = document.getElementById('invoke-btn');
      if (!invokeBtn.disabled && window.fiber) {
        invokeSelectedCommand();
      }
    }
    
    // Escape 清空输出
    if (event.key === 'Escape') {
      const output = document.getElementById('output');
      if (output.textContent !== '等待命令执行...') {
        output.textContent = '等待命令执行...';
        showMessage('输出已清空', 'info');
      }
    }
  });
  
  // 添加表单验证
  function validateForm() {
    const configSelect = document.getElementById('config-file-select');
    const privateKeyInput = document.getElementById('private-key-input');
    const peerIdInput = document.getElementById('peer-id-input');
    
    // 验证私钥格式
    if (privateKeyInput.value.trim() && !/^[0-9a-fA-F]{64}$/.test(privateKeyInput.value.trim())) {
      showMessage('私钥格式错误，应为64位十六进制字符串', 'error');
      privateKeyInput.focus();
      return false;
    }
    
    // 验证Peer ID格式
    if (peerIdInput.value.trim() && !/^[0-9a-fA-F]{64}$/.test(peerIdInput.value.trim())) {
      showMessage('Peer ID格式错误，应为64位十六进制字符串', 'error');
      peerIdInput.focus();
      return false;
    }
    
    return true;
  }
  
  // 增强的初始化函数
  window.initializeWorkers = () => {
    // 添加输入框的实时验证
    const privateKeyInput = document.getElementById('private-key-input');
    const peerIdInput = document.getElementById('peer-id-input');
    
    privateKeyInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !/^[0-9a-fA-F]*$/.test(value)) {
        this.style.borderColor = '#e74c3c';
        showMessage('私钥只能包含十六进制字符 (0-9, a-f, A-F)', 'warning');
      } else if (value && value.length !== 64 && value.length > 0) {
        this.style.borderColor = '#f39c12';
      } else {
        this.style.borderColor = '';
      }
    });
    
    peerIdInput.addEventListener('input', function() {
      const value = this.value.trim();
      if (value && !/^[0-9a-fA-F]*$/.test(value)) {
        this.style.borderColor = '#e74c3c';
        showMessage('Peer ID只能包含十六进制字符 (0-9, a-f, A-F)', 'warning');
      } else if (value && value.length !== 64 && value.length > 0) {
        this.style.borderColor = '#f39c12';
      } else {
        this.style.borderColor = '';
      }
    });
    
    // 添加提示信息
    showMessage('欢迎使用 P2P Channel Manager！按 Ctrl/Cmd+Enter 快速执行命令，按 Escape 清空输出。', 'info');
  };

  // Initialize on page load
  window.onload = () => {
    initializeWorkers();
  };
</script>
</body>
</html>